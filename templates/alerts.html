<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>告警管理 - 服务器监控系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .alert-critical { background-color: #f8d7da; border-color: #f5c6cb; }
        .alert-high { background-color: #fff3cd; border-color: #ffeaa7; }
        .alert-medium { background-color: #d1ecf1; border-color: #bee5eb; }
        .alert-low { background-color: #d4edda; border-color: #c3e6cb; }
        .severity-badge { font-size: 0.8em; padding: 0.3em 0.6em; }
        .rule-card { transition: all 0.3s ease; }
        .rule-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-server"></i> 服务器监控系统
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">首页</a>
                <a class="nav-link" href="/monitor_dashboard">监控大屏</a>
                <a class="nav-link" href="/monitor_management">监控管理</a>
                <a class="nav-link active" href="/alerts">告警管理</a>
                <a class="nav-link" href="/historical_data">历史数据</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h2><i class="fas fa-bell text-warning"></i> 告警管理</h2>
                <p class="text-muted">监控系统告警规则和通知管理</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                    <i class="fas fa-plus"></i> 创建告警规则
                </button>
            </div>
        </div>

        <!-- 活跃告警 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> 活跃告警
                            <span id="activeAlertsCount" class="badge bg-danger ms-2">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="activeAlertsList" class="alert-list">
                            <!-- 活跃告警将在这里动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 告警规则 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog"></i> 告警规则</h5>
                    </div>
                    <div class="card-body">
                        <div id="alertRulesList" class="row">
                            <!-- 告警规则将在这里动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建告警规则模态框 -->
    <div class="modal fade" id="createRuleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建告警规则</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRuleForm">
                        <div class="mb-3">
                            <label class="form-label">规则名称</label>
                            <input type="text" class="form-control" name="rule_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">目标主机</label>
                            <select class="form-control" name="host_ip" required>
                                <!-- 主机选项将动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">监控指标</label>
                            <select class="form-control" name="metric_type" required>
                                <option value="cpu">CPU使用率</option>
                                <option value="memory">内存使用率</option>
                                <option value="disk">磁盘使用率</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">比较运算符</label>
                            <select class="form-control" name="comparison_operator" required>
                                <option value=">">大于</option>
                                <option value=">=">大于等于</option>
                                <option value="<">小于</option>
                                <option value="<=">小于等于</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">阈值 (%)</label>
                            <input type="number" class="form-control" name="threshold_value" min="0" max="100" step="0.1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createAlertRule()">创建规则</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveAlerts();
            loadAlertRules();
            loadHostsForRuleCreation();
        });

        // 加载活跃告警
        async function loadActiveAlerts() {
            try {
                const response = await fetch('/api/alerts/active');
                const alerts = await response.json();
                
                const container = document.getElementById('activeAlertsList');
                const countElement = document.getElementById('activeAlertsCount');
                
                countElement.textContent = alerts.length;
                
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="alert alert-success">暂无活跃告警</div>';
                    return;
                }

                let html = '';
                alerts.forEach(alert => {
                    const severityClass = `alert-${alert.severity}`;
                    html += `
                        <div class="alert ${severityClass} d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${alert.message}</strong><br>
                                <small class="text-muted">触发时间: ${new Date(alert.created_at).toLocaleString()}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="resolveAlert(${alert.id})">
                                标记为已解决
                            </button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('加载告警失败:', error);
            }
        }

        // 加载告警规则
        async function loadAlertRules() {
            try {
                const response = await fetch('/api/alert_rules');
                const rules = await response.json();
                
                const container = document.getElementById('alertRulesList');
                
                if (rules.length === 0) {
                    container.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无告警规则</div></div>';
                    return;
                }

                let html = '';
                rules.forEach(rule => {
                    const metricNames = {
                        'cpu': 'CPU使用率',
                        'memory': '内存使用率', 
                        'disk': '磁盘使用率'
                    };
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card rule-card">
                                <div class="card-body">
                                    <h6 class="card-title">${rule.rule_name}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            主机: ${rule.host_ip}<br>
                                            指标: ${metricNames[rule.metric_type]} ${rule.comparison_operator} ${rule.threshold_value}%<br>
                                            状态: ${rule.is_active ? '<span class="text-success">启用</span>' : '<span class="text-danger">禁用</span>'}
                                        </small>
                                    </p>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">创建: ${new Date(rule.created_at).toLocaleDateString()}</small>
                                        <button class="btn btn-sm btn-danger" onclick="deleteAlertRule(${rule.id})">
                                            <i class="fas fa-trash"></i> 删除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('加载规则失败:', error);
            }
        }

// 为主机选择框加载主机列表
async function loadHostsForRuleCreation() {
    try {
        const response = await fetch('/api/hosts');
        const data = await response.json();
        
        const select = document.querySelector('select[name="host_ip"]');
        select.innerHTML = '';
        
        // 正确获取主机数组：从data.hosts对象中提取值
        const hosts = Object.values(data.hosts);
        
        // 遍历主机数组
        hosts.forEach(host => {
            const option = document.createElement('option');
            option.value = host.ip;
            option.textContent = `${host.ip} (${host.user})`;
            select.appendChild(option);
        });
        
        // 如果没有主机，显示提示
        if (hosts.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '暂无可用主机，请先添加主机';
            option.disabled = true;
            select.appendChild(option);
        }
    } catch (error) {
        console.error('加载主机列表失败:', error);
        const select = document.querySelector('select[name="host_ip"]');
        select.innerHTML = '<option value="" disabled>加载主机失败，请刷新页面</option>';
    }
}

// 创建告警规则
async function createAlertRule() {
    const form = document.getElementById('createRuleForm');
    const formData = new FormData(form);
    
    const ruleData = {
        rule_name: formData.get('rule_name'),
        host_ip: formData.get('host_ip'),
        metric_type: formData.get('metric_type'),
        comparison_operator: formData.get('comparison_operator'),
        threshold_value: parseFloat(formData.get('threshold_value'))
    };

    try {
        const response = await fetch('/api/alert_rules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(ruleData)
        });

        const result = await response.json();
        
        if (result.success) {
            alert('告警规则创建成功');
            
            // 修复：使用原生JavaScript关闭模态框，避免jQuery依赖
            const modal = document.getElementById('createRuleModal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            bootstrapModal.hide();
            
            form.reset();
            loadAlertRules();
        } else {
            alert('创建失败: ' + result.message);
        }
    } catch (error) {
        console.error('创建规则失败:', error);
        alert('创建失败: ' + error.message);
    }
}

        // 删除告警规则
        async function deleteAlertRule(ruleId) {
            if (!confirm('确定要删除这个告警规则吗？')) return;
            
            try {
                const response = await fetch(`/api/alert_rules/${ruleId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('告警规则删除成功');
                    loadAlertRules();
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('删除规则失败:', error);
                alert('删除失败，请检查网络连接');
            }
        }

        // 解决告警
        async function resolveAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/resolve`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('告警已标记为已解决');
                    loadActiveAlerts();
                } else {
                    alert('操作失败: ' + result.message);
                }
            } catch (error) {
                console.error('解决告警失败:', error);
                alert('操作失败，请检查网络连接');
            }
        }

        // 定时刷新活跃告警（每30秒）
        setInterval(loadActiveAlerts, 30000);
    </script>
</body>
</html>

