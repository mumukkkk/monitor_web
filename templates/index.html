<!DOCTYPE html>
<html>
<head>
    <title>æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .server-list {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        .server-list th, .server-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .server-list th {
            background-color: #f2f2f2;
        }
        .server-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .add-server-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-right: 5px;
        }
        .edit-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-online {
        color: #4CAF50;
        font-weight: bold;
        }
        .status-offline {
            color: #f44336;
            font-weight: bold;
        }
        .usage-low {
            color: #4CAF50;
        }
        .usage-medium {
            color: #ff9800;
        }
        .usage-high {
            color: #f44336;
            font-weight: bold;
        }
        .nav-buttons {
        margin: 20px 0;
        text-align: center;
        }

        .nav-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .nav-btn:hover {
            background-color: #1976D2;
        }

        .nav-btn.active {
            background-color: #0D47A1;
            font-weight: bold;
        }

    /* ========== æ·±è‰²/ç™½å¤©æ¨¡å¼æ ·å¼ ========== */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #1976D2;
            transform: scale(1.05);
        }

        /* æ·±è‰²æ¨¡å¼æ ·å¼ï¼ˆä¸ç›‘æ§å¤§å±ä¸€è‡´ï¼‰ */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #fff;
        }

        body.dark-mode .server-list {
            background-color: #2d2d2d;
        }

        body.dark-mode .server-list th, 
        body.dark-mode .server-list td {
            border: 1px solid #444;
            color: #fff;
        }

        body.dark-mode .server-list th {
            background-color: #3d3d3d;
        }

        body.dark-mode .server-list tr:nth-child(even) {
            background-color: #353535;
        }

        body.dark-mode .server-list tr:hover {
            background-color: #4d4d4d;
        }

        body.dark-mode .modal {
            background-color: rgba(0,0,0,0.7);
        }

        body.dark-mode .modal-content {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #fff;
        }

        body.dark-mode .close {
            color: #aaa;
        }

        body.dark-mode .close:hover {
            color: #fff;
        }

        body.dark-mode .form-group label {
            color: #fff;
        }

        body.dark-mode .form-group input {
            background-color: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
        }

        body.dark-mode .form-group input:focus {
            border-color: #2196F3;
        }

        body.dark-mode .nav-btn {
            background-color: #2196F3;
        }

        body.dark-mode .nav-btn.active {
            background-color: #0D47A1;
        }

        /* ç™½å¤©æ¨¡å¼ä¿æŒåŸæœ‰æ ·å¼ï¼Œä¸éœ€è¦é¢å¤–å®šä¹‰ */
    /* ========== æ¨¡å¼åˆ‡æ¢æ ·å¼ç»“æŸ ========== */
    </style>
</head>
<body>
    <!-- ========== æ¨¡å¼åˆ‡æ¢æŒ‰é’® ========== -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
    <!-- ========== æ¨¡å¼åˆ‡æ¢æŒ‰é’®ç»“æŸ ========== -->
    <h1>æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ</h1>

    <div class="nav-buttons">
        <button class="nav-btn active" onclick="showHostManagement()">ä¸»æœºç®¡ç†</button>
        <button class="nav-btn" onclick="showMonitorDashboard()">ç›‘æ§å¤§å±</button>
        <button class="nav-btn" onclick="showMonitorManagement()">ç›‘æ§ç®¡ç†</button>
	    <button class="nav-btn" onclick="showAlerts()">å‘Šè­¦ç®¡ç†</button>
        <button class="nav-btn" onclick="showHistoricalData()">å†å²æ•°æ®</button>
    </div>
    
    <button class="add-server-btn" onclick="openAddModal()">æ·»åŠ æœåŠ¡å™¨</button>
    
    <div id="message"></div>
    
    <h2>æœåŠ¡å™¨åˆ—è¡¨</h2>
    <table class="server-list">
        <thead>
            <tr>
                <th>IPåœ°å€</th>
                <th>ç”¨æˆ·å</th>
                <th>ç«¯å£</th>
                <th>çŠ¶æ€</th>
                <th>CPUä½¿ç”¨ç‡</th>
                <th>å†…å­˜ä½¿ç”¨ç‡</th>
                <th>ç£ç›˜ä½¿ç”¨ç‡</th>
                <th>æœ€åæ£€æŸ¥æ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="server-list-body">
            {% for host in hosts %}
            <tr id="host-{{ host[0] }}-{{ host[1] }}-{{ host[3] }}">
                <td>{{ host[0] }}</td>
                <td>{{ host[1] }}</td>
                <td>{{ host[3] }}</td>
                <td id="status-{{ host[0] }}-{{ host[1] }}-{{ host[3] }}">
                    <span class="status-offline">ç¦»çº¿</span>
                </td>
                <td id="cpu-{{ host[0] }}-{{ host[1] }}-{{ host[3] }}">0.00%</td>
                <td id="memory-{{ host[0] }}-{{ host[1] }}-{{ host[3] }}">0.00%</td>
                <td id="disk-{{ host[0] }}-{{ host[1] }}-{{ host[3] }}">0.00%</td>
                <td id="checktime-{{ host[0] }}-{{ host[1] }}-{{ host[3] }}">-</td>
                <td>
                    <button class="edit-btn" onclick="openEditModal('{{ host[0] }}', '{{ host[1] }}', '{{ host[3] }}')">ç¼–è¾‘</button>
                    <button class="delete-btn" onclick="openDeleteModal('{{ host[0] }}', '{{ host[1] }}', '{{ host[3] }}')">åˆ é™¤</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- æ·»åŠ æœåŠ¡å™¨æ¨¡æ€çª—å£ -->
    <div id="addServerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>æ·»åŠ æœåŠ¡å™¨</h2>
            <form id="add-host-form">
                <div class="form-group">
                    <label for="ip">ä¸»æœºIPï¼š</label>
                    <input type="text" id="ip" name="ip" required>
                </div>
                <div class="form-group">
                    <label for="user">SSHç”¨æˆ·åï¼š</label>
                    <input type="text" id="user" name="user" required>
                </div>
                <div class="form-group">
                    <label for="pwd">SSHå¯†ç ï¼š</label>
                    <input type="password" id="pwd" name="pwd" required>
                </div>
                <div class="form-group">
                    <label for="port">SSHç«¯å£ï¼ˆå¯é€‰ï¼Œé»˜è®¤22ï¼‰ï¼š</label>
                    <input type="number" id="port" name="port" value="22" min="1" max="65535">
                </div>
                <button type="submit">æ·»åŠ </button>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘æœåŠ¡å™¨æ¨¡æ€çª—å£ -->
    <div id="editServerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>ç¼–è¾‘æœåŠ¡å™¨</h2>
            <form id="edit-host-form">
                <input type="hidden" id="old_ip" name="old_ip">
                <input type="hidden" id="old_user" name="old_user">
                <input type="hidden" id="old_port" name="old_port">
                
                <div class="form-group">
                    <label for="new_ip">ä¸»æœºIPï¼š</label>
                    <input type="text" id="new_ip" name="new_ip" required>
                </div>
                <div class="form-group">
                    <label for="new_user">SSHç”¨æˆ·åï¼š</label>
                    <input type="text" id="new_user" name="new_user" required>
                </div>
                <div class="form-group">
                    <label for="new_pwd">SSHå¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰ï¼š</label>
                    <input type="password" id="new_pwd" name="new_pwd">
                </div>
                <div class="form-group">
                    <label for="new_port">SSHç«¯å£ï¼š</label>
                    <input type="number" id="new_port" name="new_port" min="1" max="65535" required>
                </div>
                <button type="submit">æ›´æ–°</button>
            </form>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€çª—å£ -->
    <div id="deleteServerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteModal()">&times;</span>
            <h2>åˆ é™¤æœåŠ¡å™¨</h2>
            <p>ç¡®å®šè¦åˆ é™¤æœåŠ¡å™¨ <span id="delete-ip"></span> å—ï¼Ÿ</p>
            <p>è¯·è¾“å…¥ç”¨æˆ·å <span id="delete-user"></span> ä»¥ç¡®è®¤åˆ é™¤ï¼š</p>
            <form id="delete-host-form">
                <input type="hidden" id="delete_ip" name="ip">
                <input type="hidden" id="delete_user" name="user">
                <input type="hidden" id="delete_port" name="port">
                
                <div class="form-group">
                    <label for="confirm_user">ç¡®è®¤ç”¨æˆ·åï¼š</label>
                    <input type="text" id="confirm_user" name="confirm_user" required>
                </div>
                <button type="submit" style="background-color: #f44336;">ç¡®è®¤åˆ é™¤</button>
            </form>
        </div>
    </div>

    <script>
        // è·å–æ¨¡æ€çª—å£å…ƒç´ 
        var addModal = document.getElementById('addServerModal');
        var editModal = document.getElementById('editServerModal');
        var deleteModal = document.getElementById('deleteServerModal');
        
        // æ‰“å¼€æ·»åŠ æ¨¡æ€çª—å£
        function openAddModal() {
            addModal.style.display = 'block';
        }
        
        // å…³é—­æ·»åŠ æ¨¡æ€çª—å£
        function closeAddModal() {
            addModal.style.display = 'none';
            document.getElementById('add-host-form').reset();
            hideMessage();
        }
        
        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€çª—å£
        function openEditModal(ip, user, port) {
            document.getElementById('old_ip').value = ip;
            document.getElementById('old_user').value = user;
            document.getElementById('old_port').value = port;
            
            document.getElementById('new_ip').value = ip;
            document.getElementById('new_user').value = user;
            document.getElementById('new_port').value = port;
            
            editModal.style.display = 'block';
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€çª—å£
        function closeEditModal() {
            editModal.style.display = 'none';
            document.getElementById('edit-host-form').reset();
            hideMessage();
        }
        
        // æ‰“å¼€åˆ é™¤æ¨¡æ€çª—å£
        function openDeleteModal(ip, user, port) {
            document.getElementById('delete_ip').value = ip;
            document.getElementById('delete_user').value = user;
            document.getElementById('delete_port').value = port;
            
            document.getElementById('delete-ip').textContent = ip;
            document.getElementById('delete-user').textContent = user;
            
            deleteModal.style.display = 'block';
        }
        
        // å…³é—­åˆ é™¤æ¨¡æ€çª—å£
        function closeDeleteModal() {
            deleteModal.style.display = 'none';
            document.getElementById('delete-host-form').reset();
            hideMessage();
        }
        
        // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target == addModal) {
                closeAddModal();
            }
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, isSuccess) {
            var messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + (isSuccess ? 'success' : 'error');
            messageDiv.style.display = 'block';
        }
        
        // éšè—æ¶ˆæ¯
        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }
        
        // æ·»åŠ ä¸»æœºè¡¨å•æäº¤
        document.getElementById('add-host-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var formData = new FormData(this);
            
            fetch('/add_host', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, true);
                    closeAddModal();
                    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æœåŠ¡å™¨åˆ—è¡¨
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showMessage(data.message, false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', false);
            });
        });
        
        // ç¼–è¾‘ä¸»æœºè¡¨å•æäº¤
        document.getElementById('edit-host-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var formData = new FormData(this);
            
            fetch('/update_host', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, true);
                    closeEditModal();
                    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æœåŠ¡å™¨åˆ—è¡¨
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showMessage(data.message, false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', false);
            });
        });
        
        // åˆ é™¤ä¸»æœºè¡¨å•æäº¤
        document.getElementById('delete-host-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var formData = new FormData(this);
            
            fetch('/delete_host', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, true);
                    closeDeleteModal();
                    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æœåŠ¡å™¨åˆ—è¡¨
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showMessage(data.message, false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', false);
            });
        });
        // è·å–å®æ—¶ç›‘æ§æ•°æ®
        function fetchRealTimeData() {
            fetch('/get_real_time_data')
                .then(response => response.json())
                .then(data => {
                    updateServerStatus(data);
                })
                .catch(error => {
                    console.error('è·å–ç›‘æ§æ•°æ®å¤±è´¥:', error);
                });
        }

        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
        function updateServerStatus(monitoringData) {
            const rows = document.querySelectorAll('#server-list-body tr');
            
            rows.forEach(row => {
                const ip = row.cells[0].textContent;
                const user = row.cells[1].textContent;
                const port = row.cells[2].textContent;
                
                const key = `${ip}-${user}-${port}`;
                const statusCell = document.getElementById(`status-${key}`);
                const cpuCell = document.getElementById(`cpu-${key}`);
                const memoryCell = document.getElementById(`memory-${key}`);
                const diskCell = document.getElementById(`disk-${key}`);
                const checkTimeCell = document.getElementById(`checktime-${key}`);
                
                if (monitoringData[ip]) {
                    const hostData = monitoringData[ip];
                    
                    // æ›´æ–°çŠ¶æ€
                    if (hostData.is_online) {
                        statusCell.innerHTML = '<span class="status-online">åœ¨çº¿</span>';
                    } else {
                        statusCell.innerHTML = '<span class="status-offline">ç¦»çº¿</span>';
                    }
                    
                    // æ›´æ–°CPUä½¿ç”¨ç‡
                    const cpuUsage = hostData.cpu_usage || 0;
                    cpuCell.textContent = cpuUsage.toFixed(2) + '%';
                    cpuCell.className = getUsageClass(cpuUsage);
                    
                    // æ›´æ–°å†…å­˜ä½¿ç”¨ç‡
                    const memoryUsage = hostData.memory_usage || 0;
                    memoryCell.textContent = memoryUsage.toFixed(2) + '%';
                    memoryCell.className = getUsageClass(memoryUsage);
                    
                    // æ›´æ–°ç£ç›˜ä½¿ç”¨ç‡
                    const diskUsage = hostData.disk_usage || 0;
                    diskCell.textContent = diskUsage.toFixed(2) + '%';
                    diskCell.className = getUsageClass(diskUsage);
                    
                    // æ›´æ–°æ—¶é—´
                    if (hostData.check_time) {
                        checkTimeCell.textContent = new Date(hostData.check_time).toLocaleString();
                    }
                } else {
                    // æ²¡æœ‰æ•°æ®çš„ä¸»æœºæ˜¾ç¤ºä¸ºç¦»çº¿
                    statusCell.innerHTML = '<span class="status-offline">ç¦»çº¿</span>';
                    cpuCell.textContent = '0.00%';
                    memoryCell.textContent = '0.00%';
                    diskCell.textContent = '0.00%';
                    checkTimeCell.textContent = '-';
                }
            });
        }

        // æ ¹æ®ä½¿ç”¨ç‡è¿”å›å¯¹åº”çš„CSSç±»
        function getUsageClass(usage) {
            if (usage < 70) {
                return 'usage-low';
            } else if (usage < 90) {
                return 'usage-medium';
            } else {
                return 'usage-high';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹å®šæ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            fetchRealTimeData();
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®ï¼ˆä¸åç«¯é‡‡é›†é¢‘ç‡ä¸€è‡´ï¼‰
            setInterval(fetchRealTimeData, 30000);
        });

        function showHostManagement() {
        // å½“å‰å·²ç»æ˜¯ä¸»æœºç®¡ç†é¡µé¢ï¼Œæ— éœ€è·³è½¬
        // åªæ˜¯æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.nav-btn').classList.add('active');
        }

        function showMonitorDashboard() {
        // è·³è½¬åˆ°ç›‘æ§å¤§å±é¡µé¢
        window.location.href = '/monitor_dashboard';
        }
        function showMonitorManagement() {
        // è·³è½¬åˆ°ç›‘æ§ç®¡ç†é¡µé¢
        window.location.href = '/monitor_management';
        }
        function showAlerts() {
        // è·³è½¬åˆ°å‘Šè­¦ç®¡ç†é¡µé¢
        window.location.href = '/alerts';
        }
        function showHistoricalData() {
        // è·³è½¬åˆ°å†å²æ•°æ®æŸ¥è¯¢é¡µé¢
        window.location.href = '/historical_data';
        }

        

        // ========== æ·±è‰²/ç™½å¤©æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ ==========
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'light'; // é»˜è®¤ç™½å¤©æ¨¡å¼

        // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
        }

        // åˆ‡æ¢ä¸»é¢˜
        themeToggle.addEventListener('click', function() {
            if (document.body.classList.contains('dark-mode')) {
                // å½“å‰æ˜¯æ·±è‰²æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°ç™½å¤©æ¨¡å¼
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
            } else {
                // å½“å‰æ˜¯ç™½å¤©æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
            }
        });
        // ========== æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ç»“æŸ ==========
    </script>
</body>
</html>




