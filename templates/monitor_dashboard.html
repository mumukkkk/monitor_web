<!DOCTYPE html>
<html>
<head>
    <title>ç›‘æ§å¤§å± - æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ</title>
    <meta charset="utf-8">
    <!-- å¼•å…¥ ECharts åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .nav-buttons {
            margin: 20px 0;
            text-align: center;
        }
        .nav-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .nav-btn:hover {
            background-color: #1976D2;
        }
        .nav-btn.active {
            background-color: #0D47A1;
            font-weight: bold;
        }
        
        /* ä¸»å¸ƒå±€ */
        .main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* å·¦ä¾§ä¸»æœºåˆ—è¡¨ */
        .host-list-container {
            width: 300px;
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .host-list-title {
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
            color: #fff;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .host-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .host-item {
            padding: 12px;
            margin: 5px 0;
            background-color: #3d3d3d;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 4px solid #666;
        }
        .host-item:hover {
            background-color: #4d4d4d;
        }
        .host-item.active {
            background-color: #2c5282;
            border-left-color: #4299e1;
        }
        .host-ip {
            font-weight: bold;
            font-size: 14px;
        }
        .host-status {
            font-size: 12px;
            margin-top: 5px;
        }
        .status-online {
            color: #4CAF50;
        }
        .status-offline {
            color: #f44336;
        }
        
        /* å³ä¾§å›¾è¡¨åŒºåŸŸ */
        .charts-container {
            flex: 1;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
        }
        .chart-container {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .chart-title {
            text-align: center;
            font-size: 18px;
            margin-bottom: 10px;
            color: #fff;
        }
        .chart {
            width: 100%;
            height: 300px;
        }
        .full-width {
            grid-column: 1 / span 2;
        }
        .stats-overview {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            margin: 10px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .host-list::-webkit-scrollbar {
            width: 6px;
        }
        .host-list::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 3px;
        }
        .host-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }
        .host-list::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* ========== æ·±è‰²/ç™½å¤©æ¨¡å¼æ ·å¼ ========== */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #1976D2;
            transform: scale(1.05);
        }

        /* ç™½å¤©æ¨¡å¼æ ·å¼ */
        body.light-mode {
            background-color: #f5f5f5;
            color: #333;
        }

        /* ç™½å¤©æ¨¡å¼ä¸‹çš„æ ‡é¢˜é¢œè‰²æ”¹ä¸ºé»‘è‰² */
        body.light-mode h1 {
            color: #000 !important;
        }

        /* å¯¼èˆªæŒ‰é’®åœ¨ç™½å¤©æ¨¡å¼ä¸‹ä¿æŒåŸæœ‰é¢œè‰² */
        body.light-mode .nav-btn {
            background-color: #2196F3 !important;
            color: white !important;
        }

        body.light-mode .nav-btn.active {
            background-color: #0D47A1 !important;
            color: white !important;
        }

        body.light-mode .nav-btn:hover {
            background-color: #1976D2 !important;
            color: white !important;
        }

        /* ç»Ÿè®¡å¡ç‰‡åœ¨ç™½å¤©æ¨¡å¼ä¸‹ä¿æŒåŸæœ‰é¢œè‰² */
        body.light-mode .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }

        /* ç»Ÿè®¡æ•°å€¼åœ¨ç™½å¤©æ¨¡å¼ä¸‹ä¿æŒç™½è‰² */
        body.light-mode .stat-value {
            color: white !important;
        }

        /* ç»Ÿè®¡æ ‡ç­¾åœ¨ç™½å¤©æ¨¡å¼ä¸‹ä¿æŒç™½è‰² */
        body.light-mode .stat-label {
            color: white !important;
            opacity: 0.9 !important;
        }

        /* ç™½å¤©æ¨¡å¼ä¸‹çš„å›¾è¡¨æ–‡å­—é¢œè‰²è°ƒæ•´ä¸ºé»‘è‰² */
        body.light-mode .chart-title {
            color: #000 !important;
        }

        body.light-mode .host-list-title {
            color: #333;
            border-bottom: 1px solid #dee2e6;
        }

        /* ç™½å¤©æ¨¡å¼ä¸‹ ECharts å›¾è¡¨çš„æ–‡å­—é¢œè‰² */
        body.light-mode .echarts,
        body.light-mode .echarts * {
            color: #000 !important;
        }

        /* ç¡®ä¿å›¾è¡¨ä¸­çš„æ–‡å­—åœ¨ç™½å¤©æ¨¡å¼ä¸‹å¯è§ */
        body.light-mode #cpuTrendChart,
        body.light-mode #memoryBarChart, 
        body.light-mode #diskRingChart,
        body.light-mode #statusPieChart,
        body.light-mode #networkChart {
            color: #000 !important;
        }

        /* å›¾è¡¨å®¹å™¨çš„æ–‡å­—é¢œè‰² */
        body.light-mode .chart {
            color: #000 !important;
        }

        body.light-mode .dashboard-container .chart-container,
        body.light-mode .host-list-container {
            background-color: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body.light-mode .host-item {
            background-color: #e9ecef;
            color: #333;
            border-left: 4px solid #adb5bd;
        }

        body.light-mode .host-item:hover {
            background-color: #dee2e6;
        }

        body.light-mode .host-item.active {
            background-color: #495057;
            color: white;
            border-left-color: #6c757d;
        }

        /* æ»šåŠ¨æ¡æ ·å¼è°ƒæ•´ */
        body.light-mode .host-list::-webkit-scrollbar-track {
            background: #e9ecef;
        }

        body.light-mode .host-list::-webkit-scrollbar-thumb {
            background: #adb5bd;
        }

        body.light-mode .host-list::-webkit-scrollbar-thumb:hover {
            background: #6c757d;
        }
        /* ========== æ¨¡å¼åˆ‡æ¢æ ·å¼ç»“æŸ ========== */
    </style>
</head>
<body>
    <!-- ========== æ¨¡å¼åˆ‡æ¢æŒ‰é’® ========== -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
    <!-- ========== æ¨¡å¼åˆ‡æ¢æŒ‰é’®ç»“æŸ ========== -->
    <h1 style="text-align: center; color: #fff;">æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ - ç›‘æ§å¤§å±</h1>
    
    <div class="nav-buttons">
        <button class="nav-btn" onclick="showHostManagement()">ä¸»æœºç®¡ç†</button>
        <button class="nav-btn active" onclick="showMonitorDashboard()">ç›‘æ§å¤§å±</button>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§ä¸»æœºåˆ—è¡¨ -->
        <div class="host-list-container">
            <div class="host-list-title">æœåŠ¡å™¨åˆ—è¡¨</div>
            <div class="host-list" id="host-list">
                <!-- ä¸»æœºåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³ä¾§å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-container">
            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-label">æ€»æœåŠ¡å™¨æ•°é‡</div>
                    <div class="stat-value" id="total-servers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">åœ¨çº¿æœåŠ¡å™¨</div>
                    <div class="stat-value" id="online-servers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡CPUä½¿ç”¨ç‡</div>
                    <div class="stat-value" id="avg-cpu">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡å†…å­˜ä½¿ç”¨ç‡</div>
                    <div class="stat-value" id="avg-memory">0%</div>
                </div>
            </div>
            
            <!-- å½“å‰é€‰ä¸­ä¸»æœºçš„IPæ˜¾ç¤º -->
            <div style="text-align: center; margin-bottom: 20px; font-size: 18px;">
                å½“å‰æŸ¥çœ‹: <span id="current-host" style="color: #4299e1; font-weight: bold;">è¯·é€‰æ‹©æœåŠ¡å™¨</span>
            </div>
            
            <div class="dashboard-container">
                <!-- CPUä½¿ç”¨ç‡è¶‹åŠ¿å›¾ -->
                <div class="chart-container">
                    <div class="chart-title">CPUä½¿ç”¨ç‡è¶‹åŠ¿å›¾</div>
                    <div id="cpuTrendChart" class="chart"></div>
                </div>
                
                <!-- å†…å­˜ä½¿ç”¨ç‡æŸ±çŠ¶å›¾ -->
                <div class="chart-container">
                    <div class="chart-title">å†…å­˜ä½¿ç”¨ç‡æŸ±çŠ¶å›¾</div>
                    <div id="memoryBarChart" class="chart"></div>
                </div>
                
                <!-- ç£ç›˜ä½¿ç”¨ç‡ç¯å½¢å›¾ -->
                <div class="chart-container">
                    <div class="chart-title">ç£ç›˜ä½¿ç”¨ç‡ç¯å½¢å›¾</div>
                    <div id="diskRingChart" class="chart"></div>
                </div>
                
                <!-- æœåŠ¡å™¨çŠ¶æ€åˆ†å¸ƒé¥¼å›¾ -->
                <div class="chart-container">
                    <div class="chart-title">æœåŠ¡å™¨çŠ¶æ€åˆ†å¸ƒ</div>
                    <div id="statusPieChart" class="chart"></div>
                </div>
                
                <!-- ç½‘ç»œæµé‡ç›‘æ§å›¾ -->
                <div class="chart-container full-width">
                    <div class="chart-title">ç½‘ç»œæµé‡ç›‘æ§å›¾</div>
                    <div id="networkChart" class="chart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showHostManagement() {
            window.location.href = '/';
        }
        
        function showMonitorDashboard() {
            // å½“å‰é¡µé¢ï¼Œæ— éœ€æ“ä½œ
        }

        // è·å–å½“å‰ä¸»é¢˜çš„æ–‡å­—é¢œè‰²
        function getTextColor() {
            return document.body.classList.contains('light-mode') ? '#000' : '#fff';
        }

        // å…¨å±€å˜é‡
        let currentSelectedHost = null;
        let allHostsData = {};
        let cpuTrendChart = echarts.init(document.getElementById('cpuTrendChart'));
        let memoryBarChart = echarts.init(document.getElementById('memoryBarChart'));
        let diskRingChart = echarts.init(document.getElementById('diskRingChart'));
        let statusPieChart = echarts.init(document.getElementById('statusPieChart'));
        let networkChart = echarts.init(document.getElementById('networkChart'));

        // CPU ä½¿ç”¨ç‡å†å²æ•°æ®å­˜å‚¨
        let cpuHistoryData = {};
        let timePoints = [];

        // åˆå§‹åŒ–ä¸»æœºåˆ—è¡¨
        function initHostList(data) {
            const hostList = document.getElementById('host-list');
            hostList.innerHTML = '';
            
            const hosts = Object.keys(data);
            
            hosts.forEach((host, index) => {
                const hostData = data[host];
                const hostItem = document.createElement('div');
                hostItem.className = 'host-item';
                if (index === 0) {
                    hostItem.classList.add('active');
                    currentSelectedHost = host;
                    document.getElementById('current-host').textContent = host;
                }
                
                hostItem.innerHTML = `
                    <div class="host-ip">${host}</div>
                    <div class="host-status ${hostData.is_online ? 'status-online' : 'status-offline'}">
                        ${hostData.is_online ? 'â— åœ¨çº¿' : 'â— ç¦»çº¿'}
                    </div>
                `;
                
                hostItem.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–ä¸»æœºçš„æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.host-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    // è®¾ç½®å½“å‰ä¸»æœºä¸ºæ¿€æ´»çŠ¶æ€
                    hostItem.classList.add('active');
                    currentSelectedHost = host;
                    document.getElementById('current-host').textContent = host;
                    // æ›´æ–°å›¾è¡¨æ˜¾ç¤ºé€‰ä¸­ä¸»æœºçš„æ•°æ®
                    updateChartsForHost(host);
                });
                
                hostList.appendChild(hostItem);
            });
        }

        // æ›´æ–°é€‰ä¸­ä¸»æœºçš„å›¾è¡¨
        function updateChartsForHost(host) {
            if (!allHostsData[host]) return;
            
            const hostData = allHostsData[host];
            const hosts = Object.keys(allHostsData);
            
            // 1. æ›´æ–°CPUè¶‹åŠ¿å›¾
            updateCpuTrendChart(host, hostData, hosts);
            
            // 2. æ›´æ–°å†…å­˜æŸ±çŠ¶å›¾
            updateMemoryBarChart(host, hostData, hosts);
            
            // 3. æ›´æ–°ç£ç›˜ç¯å½¢å›¾
            updateDiskRingChart(host, hostData);
            
            // 4. æ›´æ–°çŠ¶æ€é¥¼å›¾
            updateStatusPieChart(allHostsData);
            
            // 5. æ›´æ–°ç½‘ç»œæµé‡å›¾
            updateNetworkChart(host, hostData, hosts);
        }

        // 1. CPUä½¿ç”¨ç‡è¶‹åŠ¿å›¾
        function updateCpuTrendChart(selectedHost, hostData, allHosts) {
            const currentTime = new Date();
            const timeLabel = currentTime.toLocaleTimeString();
            
            // åˆå§‹åŒ–å†å²æ•°æ®å­˜å‚¨
            if (timePoints.length === 0) {
                // é¦–æ¬¡è°ƒç”¨ï¼Œåˆå§‹åŒ–æ—¶é—´ç‚¹
                for (let i = 9; i >= 0; i--) {
                    const time = new Date(currentTime.getTime() - i * 60000); // æ¯åˆ†é’Ÿä¸€ä¸ªç‚¹
                    timePoints.push(time.toLocaleTimeString());
                }
                
                // åˆå§‹åŒ–æ¯ä¸ªä¸»æœºçš„å†å²æ•°æ®
                allHosts.forEach(host => {
                    cpuHistoryData[host] = new Array(10).fill(0); // åˆå§‹åŒ–ä¸º10ä¸ª0
                });
            } else {
                // æ›´æ–°æ—¶é—´ç‚¹ï¼šç§»é™¤æœ€æ—§çš„æ—¶é—´ç‚¹ï¼Œæ·»åŠ æœ€æ–°çš„æ—¶é—´ç‚¹
                timePoints.shift(); // ç§»é™¤ç¬¬ä¸€ä¸ªï¼ˆæœ€æ—§çš„ï¼‰æ—¶é—´ç‚¹
                timePoints.push(timeLabel); // æ·»åŠ æœ€æ–°çš„æ—¶é—´ç‚¹
            }
            
            // æ›´æ–°æ¯ä¸ªä¸»æœºçš„CPUä½¿ç”¨ç‡å†å²æ•°æ®
            allHosts.forEach(host => {
                if (!cpuHistoryData[host]) {
                    cpuHistoryData[host] = new Array(10).fill(0);
                }
                
                const cpuUsage = allHostsData[host].cpu_usage || 0;
                
                // å¦‚æœå†å²æ•°æ®é•¿åº¦è¶…è¿‡10ï¼Œç§»é™¤æœ€æ—§çš„æ•°æ®
                if (cpuHistoryData[host].length >= 10) {
                    cpuHistoryData[host].shift(); // ç§»é™¤æœ€æ—§çš„æ•°æ®ç‚¹
                }
                
                // æ·»åŠ æœ€æ–°çš„æ•°æ®ç‚¹
                cpuHistoryData[host].push(cpuUsage);
                
                // ç¡®ä¿æ•°æ®é•¿åº¦ä¸æ—¶é—´ç‚¹ä¸€è‡´
                while (cpuHistoryData[host].length < timePoints.length) {
                    cpuHistoryData[host].unshift(0); // åœ¨å‰é¢è¡¥0
                }
                while (cpuHistoryData[host].length > timePoints.length) {
                    cpuHistoryData[host].shift(); // ç§»é™¤å¤šä½™çš„æ•°æ®
                }
            });
            
            // ä¸ºæ‰€æœ‰ä¸»æœºåˆ›å»ºæ•°æ®ç³»åˆ—
            const seriesData = allHosts.map(host => {
                const isSelected = host === selectedHost;
                return {
                    name: host,
                    type: 'line',
                    data: cpuHistoryData[host] || new Array(timePoints.length).fill(0),
                    smooth: true,
                    lineStyle: {
                        width: isSelected ? 4 : 2,
                        color: isSelected ? '#FF6B6B' : undefined
                    },
                    itemStyle: {
                        color: isSelected ? '#FF6B6B' : undefined
                    },
                    emphasis: {
                        lineStyle: {
                            width: 5
                        }
                    }
                };
            });

            const option = {
                title: {
                    text: 'CPUä½¿ç”¨ç‡è¶‹åŠ¿',
                    textStyle: {
                        color: getTextColor()
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            result += `${param.seriesName}: ${param.value}%<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: allHosts,
                    textStyle: {
                        color: getTextColor()
                    },
                    type: 'scroll',
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: timePoints,
                    axisLabel: {
                        color: getTextColor(),
                        rotate: 45 // æ—¶é—´æ ‡ç­¾æ—‹è½¬45åº¦ï¼Œé¿å…é‡å 
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%',
                        color: getTextColor()
                    }
                },
                series: seriesData
            };

            cpuTrendChart.setOption(option);
        }
        // 2. å†…å­˜ä½¿ç”¨ç‡æŸ±çŠ¶å›¾
        function updateMemoryBarChart(selectedHost, hostData, allHosts) {
            const memoryData = allHosts.map(host => {
                const isSelected = host === selectedHost;
                const memoryUsage = allHostsData[host].memory_usage || 0;
                return {
                    value: memoryUsage,
                    itemStyle: {
                        color: isSelected ? '#FF6B6B' : 
                               memoryUsage >= 90 ? '#F44336' : 
                               memoryUsage >= 70 ? '#FF9800' : '#4CAF50'
                    }
                };
            });

            const option = {
                title: {
                    text: 'å†…å­˜ä½¿ç”¨ç‡',
                    textStyle: {
                        color: getTextColor()
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: allHosts,
                    axisLabel: {
                        color: getTextColor(),
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%',
                        color: getTextColor()
                    }
                },
                series: [{
                    data: memoryData,
                    type: 'bar',
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}%',
                        color: getTextColor()
                    }
                }]
            };

            memoryBarChart.setOption(option);
        }

        // 3. ç£ç›˜ä½¿ç”¨ç‡ç¯å½¢å›¾
        function updateDiskRingChart(selectedHost, hostData) {
            const diskUsage = hostData.disk_usage || 0;
            
            const option = {
                title: {
                    text: 'ç£ç›˜ä½¿ç”¨ç‡',
                    textStyle: {
                        color: getTextColor()
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c}%'
                },
                series: [
                    {
                        name: 'ç£ç›˜ä½¿ç”¨ç‡',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: document.body.classList.contains('light-mode') ? '#fff' : '#1a1a1a',
                            borderWidth: 2,
                            color: diskUsage >= 90 ? '#F44336' : 
                                  diskUsage >= 70 ? '#FF9800' : '#4CAF50'
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '20',
                                fontWeight: 'bold',
                                color: getTextColor(),
                                formatter: `${diskUsage.toFixed(1)}%`
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            {value: diskUsage, name: 'å·²ä½¿ç”¨'},
                            {value: 100 - diskUsage, name: 'å‰©ä½™ç©ºé—´'}
                        ]
                    }
                ]
            };

            diskRingChart.setOption(option);
        }

        // 4. æœåŠ¡å™¨çŠ¶æ€åˆ†å¸ƒé¥¼å›¾
        function updateStatusPieChart(data) {
            const hosts = Object.keys(data);
            let onlineCount = 0;
            let offlineCount = 0;

            hosts.forEach(host => {
                if (data[host].is_online) {
                    onlineCount++;
                } else {
                    offlineCount++;
                }
            });

            const option = {
                title: {
                    text: 'æœåŠ¡å™¨çŠ¶æ€åˆ†å¸ƒ',
                    textStyle: {
                        color: getTextColor()
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    textStyle: {
                        color: getTextColor()
                    }
                },
                series: [
                    {
                        name: 'æœåŠ¡å™¨çŠ¶æ€',
                        type: 'pie',
                        radius: '50%',
                        data: [
                            { value: onlineCount, name: 'åœ¨çº¿', itemStyle: { color: '#4CAF50' } },
                            { value: offlineCount, name: 'ç¦»çº¿', itemStyle: { color: '#F44336' } }
                        ],
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        label: {
                            color: getTextColor()
                        }
                    }
                ]
            };

            statusPieChart.setOption(option);
        }

        // 5. ç½‘ç»œæµé‡ç›‘æ§å›¾
        function updateNetworkChart(selectedHost, hostData, allHosts) {
            const networkInData = allHosts.map(host => {
                const isSelected = host === selectedHost;
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æˆ–å®é™…æ•°æ®
                const networkRx = allHostsData[host].network_rx || Math.random() * 100;
                return {
                    value: networkRx,
                    itemStyle: {
                        color: isSelected ? '#5470c6' : '#91cc75'
                    }
                };
            });

            const networkOutData = allHosts.map(host => {
                const isSelected = host === selectedHost;
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æˆ–å®é™…æ•°æ®
                const networkTx = allHostsData[host].network_tx || Math.random() * 100;
                return {
                    value: networkTx,
                    itemStyle: {
                        color: isSelected ? '#5470c6' : '#fac858'
                    }
                };
            });

            const option = {
                title: {
                    text: 'ç½‘ç»œæµé‡ç›‘æ§',
                    textStyle: {
                        color: getTextColor()
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['ç½‘ç»œæµå…¥ (MB)', 'ç½‘ç»œæµå‡º (MB)'],
                    textStyle: {
                        color: getTextColor()
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: allHosts,
                    axisLabel: {
                        color: getTextColor(),
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value} MB',
                        color: getTextColor()
                    }
                },
                series: [
                    {
                        name: 'ç½‘ç»œæµå…¥ (MB)',
                        type: 'bar',
                        data: networkInData,
                        label: {
                            show: true,
                            position: 'top',
                            color: getTextColor()
                        }
                    },
                    {
                        name: 'ç½‘ç»œæµå‡º (MB)',
                        type: 'bar',
                        data: networkOutData,
                        label: {
                            show: true,
                            position: 'top',
                            color: getTextColor()
                        }
                    }
                ]
            };

            networkChart.setOption(option);
        }

        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        function updateStatsOverview(data) {
            const hosts = Object.keys(data);
            const totalServers = hosts.length;
            const onlineServers = hosts.filter(host => data[host].is_online).length;
            
            const avgCpu = hosts.reduce((sum, host) => sum + (data[host].cpu_usage || 0), 0) / totalServers || 0;
            const avgMemory = hosts.reduce((sum, host) => sum + (data[host].memory_usage || 0), 0) / totalServers || 0;

            document.getElementById('total-servers').textContent = totalServers;
            document.getElementById('online-servers').textContent = onlineServers;
            document.getElementById('avg-cpu').textContent = avgCpu.toFixed(1) + '%';
            document.getElementById('avg-memory').textContent = avgMemory.toFixed(1) + '%';
        }

        // è·å–ç›‘æ§æ•°æ®å¹¶æ›´æ–°æ‰€æœ‰å›¾è¡¨
        function fetchMonitoringData() {
            fetch('/get_real_time_data')
                .then(response => response.json())
                .then(data => {
                    allHostsData = data;
                    updateStatsOverview(data);
                    
                    // åˆå§‹åŒ–ä¸»æœºåˆ—è¡¨
                    if (Object.keys(data).length > 0) {
                        initHostList(data);
                        
                        // æ›´æ–°å›¾è¡¨æ˜¾ç¤ºç¬¬ä¸€ä¸ªä¸»æœºçš„æ•°æ®
                        const firstHost = Object.keys(data)[0];
                        updateChartsForHost(firstHost);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç›‘æ§æ•°æ®å¤±è´¥:', error);
                });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            fetchMonitoringData();
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
            setInterval(fetchMonitoringData, 30000);
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®å›¾è¡¨å¤§å°
            window.addEventListener('resize', function() {
                cpuTrendChart.resize();
                memoryBarChart.resize();
                diskRingChart.resize();
                statusPieChart.resize();
                networkChart.resize();
            });
        });

        // ========== æ·±è‰²/ç™½å¤©æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ ==========
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'dark';

        // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
        if (currentTheme === 'light') {
            document.body.classList.add('light-mode');
            themeToggle.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
        } else {
            document.body.classList.remove('light-mode');
            themeToggle.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
        }

        // åˆ‡æ¢ä¸»é¢˜
        themeToggle.addEventListener('click', function() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
            } else {
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
            }
            
            // ä¸»é¢˜åˆ‡æ¢åé‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
            setTimeout(() => {
                if (currentSelectedHost) {
                    updateChartsForHost(currentSelectedHost);
                } else if (Object.keys(allHostsData).length > 0) {
                    const firstHost = Object.keys(allHostsData)[0];
                    updateChartsForHost(firstHost);
                }
            }, 100);
        });
        // ========== æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ç»“æŸ ==========
    </script>
</body>
</html>