<!DOCTYPE html>
<html>
<head>
    <title>ç›‘æ§ç®¡ç† - æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ</title>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        /* å¯¼èˆªæŒ‰é’®æ ·å¼ */
        .nav-buttons {
            margin: 20px 0;
            text-align: center;
        }
        
        .nav-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn:hover {
            background-color: #1976D2;
        }
        
        .nav-btn.active {
            background-color: #0D47A1;
            font-weight: bold;
        }
        
        /* ä¸»æœºç›‘æ§åˆ—è¡¨æ ·å¼ */
        .host-monitor-list {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        
        .host-monitor-list th, .host-monitor-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .host-monitor-list th {
            background-color: #f2f2f2;
        }
        
        .host-monitor-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .host-monitor-list tr:hover {
            background-color: #f5f5f5;
        }
        
        /* çŠ¶æ€æ ·å¼ */
        .status-online {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .status-offline {
            color: #f44336;
            font-weight: bold;
        }
        
        .status-paused {
            color: #ff9800;
            font-weight: bold;
        }
        
        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
        }
        
        .pause-btn {
            background-color: #ff9800;
        }
        
        .resume-btn {
            background-color: #4CAF50;
        }
        
        .edit-btn {
            background-color: #2196F3;
        }
        
        .delete-btn {
            background-color: #f44336;
        }
        
        .add-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        /* ç›‘æ§é…ç½®å¡ç‰‡æ ·å¼ */
        .monitor-config-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .monitor-config-card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .config-item input, .config-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        
        .config-item .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
        .status-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active {
            background-color: #4CAF50;
        }
        
        .status-inactive {
            background-color: #f44336;
        }
        
        /* æ—¥å¿—å®¹å™¨æ ·å¼ */
        .log-container {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        /* æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        /* ========== æ·±è‰²/ç™½å¤©æ¨¡å¼åˆ‡æ¢æ ·å¼ ========== */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: #1976D2;
            transform: scale(1.05);
        }
        
        /* æ·±è‰²æ¨¡å¼æ ·å¼ */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #fff;
        }
        
        body.dark-mode .monitor-config-card {
            background-color: #2d2d2d;
            border: 1px solid #444;
        }
        
        body.dark-mode .host-monitor-list {
            background-color: #2d2d2d;
        }
        
        body.dark-mode .host-monitor-list th, 
        body.dark-mode .host-monitor-list td {
            border: 1px solid #444;
            color: #fff;
        }
        
        body.dark-mode .host-monitor-list th {
            background-color: #3d3d3d;
        }
        
        body.dark-mode .host-monitor-list tr:nth-child(even) {
            background-color: #353535;
        }
        
        body.dark-mode .host-monitor-list tr:hover {
            background-color: #4d4d4d;
        }
        
        body.dark-mode .modal {
            background-color: rgba(0,0,0,0.7);
        }
        
        body.dark-mode .modal-content {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #fff;
        }
        
        body.dark-mode .close {
            color: #aaa;
        }
        
        body.dark-mode .close:hover {
            color: #fff;
        }
        
        body.dark-mode .config-item label {
            color: #fff;
        }
        
        body.dark-mode .config-item input, 
        body.dark-mode .config-item select {
            background-color: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
        }
        
        body.dark-mode .config-item input:focus, 
        body.dark-mode .config-item select:focus {
            border-color: #2196F3;
        }
        /* æ·±è‰²æ¨¡å¼ä¸‹å¡ç‰‡æ ‡é¢˜å’Œå¸®åŠ©æ–‡å­—çš„é¢œè‰² */
        body.dark-mode .monitor-config-card h3 {
            color: #fff;
        }

        body.dark-mode .help-text {
            color: #aaa;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹ç›‘æ§é¡¹é€‰æ‹©çš„é¢œè‰² */
        body.dark-mode .monitor-item label {
            color: #fff;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹æŒ‰é’®ç»„çš„é¢œè‰² */
        body.dark-mode .button-group {
            color: #fff;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çŠ¶æ€æ–‡æœ¬çš„é¢œè‰² */
        body.dark-mode .status-container {
            color: #fff;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹è¡¨æ ¼æ ‡é¢˜çš„é¢œè‰² */
        body.dark-mode .host-monitor-list h3 {
            color: #fff;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹æ—¥å¿—å®¹å™¨çš„é¢œè‰² */
        body.dark-mode .log-container {
            color: #d4d4d4;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹è¿›åº¦æ¡çš„é¢œè‰² */
        body.dark-mode .progress-fill {
            border: 1px solid #444;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹é¢åŒ…å±‘å¯¼èˆªçš„é¢œè‰² */
        body.dark-mode .breadcrumb {
            color: #aaa;
        }

        body.dark-mode .breadcrumb a {
            color: #64B5F6;
        }

        
        body.dark-mode .nav-btn {
            background-color: #2196F3;
        }
        
        body.dark-mode .nav-btn.active {
            background-color: #0D47A1;
        }
        
        /* ç›‘æ§é¡¹é€‰æ‹©æ ·å¼ */
        .monitor-item {
            margin: 10px 0;
        }
        
        /* æç¤ºæ¶ˆæ¯æ ·å¼ */
        .alert-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
            min-width: 200px;
            max-width: 400px;
            display: none;
        }

        body.dark-mode .alert-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .modal-content {
                width: 80%;
            }
            
        }



        .monitor-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .monitor-item input[type="checkbox"] {
            margin-right: 10px;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
            border: 1px solid #ddd;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease-in-out;
            min-width: 0%;
        }
        
        .progress-low {
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.3);
        }
        
        .progress-medium {
            background: linear-gradient(90deg, #FF9800, #FFB74D);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.3);
        }
        
        .progress-high {
            background: linear-gradient(90deg, #F44336, #EF5350);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.3);
        }
        
        /* ç¡®ä¿è¿›åº¦æ¡æ–‡æœ¬å¯è§ */
        .cpu-cell, .memory-cell, .disk-cell {
            position: relative;
        }

        .cpu-cell span, .memory-cell span, .disk-cell span {
            display: block;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            margin-top: 2px;
        }

        body.dark-mode .progress-bar {
            background-color: #3d3d3d;
        }
        
        /* é¢åŒ…å±‘å¯¼èˆª */
        .breadcrumb {
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .breadcrumb a {
            color: #2196F3;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        body.dark-mode .breadcrumb {
            color: #aaa;
        }
        
        body.dark-mode .breadcrumb a {
            color: #64B5F6;
        }
        

        /* æ—¥å¿—æŠ˜å é¢æ¿æ ·å¼ */
        .log-host-group {
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
        }
        .log-host-header {
            padding: 8px;
            background-color: #2d2d2d;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .log-host-content {
            padding: 8px;
            display: none;
        }
        .log-host-group.expanded .log-host-content {
            display: block;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .host-monitor-list th, .host-monitor-list td {
                padding: 4px;
                font-size: 12px;
            }
            .progress-bar {
                height: 12px;
            }
        }


    </style>
</head>
<body>
    <!-- ========== æ¨¡å¼åˆ‡æ¢æŒ‰é’® ========== -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
    <!-- ========== æ¨¡å¼åˆ‡æ¢æŒ‰é’®ç»“æŸ ========== -->
    
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <div class="breadcrumb">
        <a href="/">æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ</a> &gt; ç›‘æ§ç®¡ç†
    </div>
    
    <h1>ç›‘æ§ç®¡ç†</h1>
    
    <div class="nav-buttons">
        <a href="/" class="nav-btn">ä¸»æœºç®¡ç†</a>
        <a href="/monitor_dashboard" class="nav-btn">ç›‘æ§å¤§å±</a>
        <button class="nav-btn active" disabled>ç›‘æ§ç®¡ç†</button>
    </div>
    
    <!-- ä¸»æœºç›‘æ§çŠ¶æ€å¡ç‰‡ -->
    <div class="monitor-config-card">
        <h3>ç›‘æ§çŠ¶æ€</h3>
        <div class="status-container">
            <span id="status-indicator" class="status-indicator status-inactive"></span>
            <span id="status-text">æœªçŸ¥</span>
            <div style="margin-left: auto;">
                <button id="refresh-status" class="action-btn edit-btn">åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>
        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
            <div>æœ€åé‡‡é›†æ—¶é—´: <span id="last-collection-time">-</span></div>
            <div>ä¸‹æ¬¡é‡‡é›†æ—¶é—´: <span id="next-collection-time">-</span></div>
        </div>
    </div>
      
    <!-- ä¸»æœºç›‘æ§åˆ—è¡¨ -->
    <div class="monitor-config-card">
        <h3>ä¸»æœºç›‘æ§é…ç½®</h3>
        <div style="margin-bottom: 10px;">
            <button id="refresh-hosts" class="action-btn edit-btn">åˆ·æ–°ä¸»æœºåˆ—è¡¨</button>
            <span style="margin-left: 10px; font-size: 12px; color: #666;">ä¸ä¸»æœºç®¡ç†é¡µé¢åŒæ­¥</span>
        </div>
        <table class="host-monitor-list">
            <thead>
                <tr>
                    <th>ä¸»æœºIP</th>
                    <th>ç”¨æˆ·å</th>
                    <th>ç«¯å£</th>
                    <th>çŠ¶æ€</th>
                    <th>ç›‘æ§é¡¹</th>
                    <th>CPU</th>
                    <th>å†…å­˜</th>
                    <th>ç£ç›˜</th>
                    <th>æœ€åæ›´æ–°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="host-monitor-list-body">
                <!-- ä¸»æœºç›‘æ§æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </tbody>
        </table>
    </div>
    
    
    <!-- ç›‘æ§æ—¥å¿— -->
    <div class="monitor-config-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ç›‘æ§æ—¥å¿—</h3>
            <div class="button-group">
                <button id="refresh-logs" class="action-btn edit-btn">åˆ·æ–°æ—¥å¿—</button>
                <button id="edit-global-config" class="action-btn edit-btn" style="margin-left: 10px;">ç¼–è¾‘é‡‡é›†é…ç½®</button>
                <button id="clear-logs" class="action-btn delete-btn" style="margin-left: 10px;">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
        <!-- æ—¥å¿—å®¹å™¨ -->
        <div id="log-container" class="log-container">
            æ­£åœ¨åŠ è½½æ—¥å¿—...
        </div>
    </div>


    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="button-group">
        <button id="run-now" class="action-btn resume-btn">ç«‹å³æ‰§è¡Œé‡‡é›†</button>
        <a href="/monitor_dashboard" class="nav-btn">æŸ¥çœ‹ç›‘æ§å¤§å±</a>
    </div>
    
    <!-- ç¼–è¾‘ä¸»æœºç›‘æ§æ¨¡æ€çª—å£ -->
    <div id="host-monitor-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHostMonitorModal()">&times;</span>
            <h2 id="modal-title">ç¼–è¾‘ä¸»æœºç›‘æ§</h2>
            <form id="host-monitor-form">
                <input type="hidden" id="modal-host-id">
                <div class="config-item">
                    <label>ä¸»æœºä¿¡æ¯:</label>
                    <div id="modal-host-info" style="padding: 10px; background: #f5f5f5; border-radius: 4px;"></div>
                </div>
                <div class="config-item">
                    <label>ç›‘æ§é¡¹:</label>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-monitor-cpu" checked>CPUä½¿ç”¨ç‡</label>
                    </div>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-monitor-memory" checked>å†…å­˜ä½¿ç”¨ç‡</label>
                    </div>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-monitor-disk" checked>ç£ç›˜ä½¿ç”¨ç‡</label>
                    </div>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-monitor-network" checked>ç½‘ç»œæµé‡</label>
                    </div>
                </div>
                <div class="config-item">
                    <label for="modal-status">ç›‘æ§çŠ¶æ€:</label>
                    <select id="modal-status">
                        <option value="active">å¯ç”¨</option>
                        <option value="paused">æš‚åœ</option>
                    </select>
                </div>
                <button type="submit" class="action-btn edit-btn">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <!-- é‡‡é›†é…ç½®ç¼–è¾‘æ¨¡æ€çª—å£ -->
    <div id="global-config-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGlobalConfigModal()">&times;</span>
            <h2>ç¼–è¾‘é‡‡é›†é…ç½®</h2>
            <form id="global-config-form">
                <div class="config-item">
                    <label for="modal-global-interval">é‡‡é›†é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="modal-global-interval" min="10" value="30">
                    <div class="help-text">å»ºè®®è®¾ç½®ä¸å°‘äº60ç§’ï¼Œé¿å…é¢‘ç¹é‡‡é›†</div>
                </div>
                <div class="config-item">
                    <label for="modal-global-cleanup-days">æ•°æ®ä¿ç•™å¤©æ•°</label>
                    <input type="number" id="modal-global-cleanup-days" min="1" value="30">
                    <div class="help-text">ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†è¶…è¿‡æ­¤å¤©æ•°çš„ç›‘æ§æ•°æ®</div>
                </div>
                <div class="config-item">
                    <label>é»˜è®¤ç›‘æ§é¡¹</label>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-global-cpu" checked>CPUä½¿ç”¨ç‡</label>
                    </div>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-global-memory" checked>å†…å­˜ä½¿ç”¨ç‡</label>
                    </div>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-global-disk" checked>ç£ç›˜ä½¿ç”¨ç‡</label>
                    </div>
                    <div class="monitor-item">
                        <label><input type="checkbox" id="modal-global-network" checked>ç½‘ç»œæµé‡</label>
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="action-btn edit-btn">ä¿å­˜é…ç½®</button>
                    <button type="button" onclick="closeGlobalConfigModal()" class="action-btn delete-btn">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ========== æ·±è‰²/ç™½å¤©æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ ==========
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
    
        // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
        }
    
        // åˆ‡æ¢ä¸»é¢˜
        themeToggle.addEventListener('click', function() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
            } else {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
            }
        });
    
        // ========== å…¨å±€å˜é‡ ==========
        let hostMonitorData = {};
    
        // ========== å®‰å…¨äº‹ä»¶ç›‘å¬å™¨ ==========
        function safeAddEventListener(elementId, event, handler) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(event, handler);
            } else {
                console.warn(`å…ƒç´  ${elementId} ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ äº‹ä»¶ç›‘å¬å™¨`);
            }
        }
    
        // ========== æ—¥å¿—æ˜¾ç¤ºåŠŸèƒ½ ==========
        function updateLogsView(logsData) {
            const logContainer = document.getElementById('log-container');
            
            if (!logsData || !logsData.logs || logsData.logs.length === 0) {
                logContainer.innerHTML = 'æš‚æ— æ—¥å¿—è®°å½•';
                return;
            }
            
            let html = '';
            
            // æ£€æŸ¥æ—¥å¿—ç±»å‹
            if (logsData.type === 'host_metrics') {
                logsData.logs.forEach(log => {
                    html += `<div class="log-host-group">${log}</div>`;
                });
            } else if (logsData.type === 'system') {
                logsData.logs.forEach(log => {
                    html += `<div class="log-line">${log}</div>`;
                });
            } else {
                logsData.logs.forEach(log => {
                    html += `<div class="log-line">${log}</div>`;
                });
            }
            
            logContainer.innerHTML = html;
        }
    
        // ========== é‡‡é›†çŠ¶æ€æ›´æ–° ==========
        function updateCollectionStatusFromData(statusData) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const lastCollectionTime = document.getElementById('last-collection-time');
            const nextCollectionTime = document.getElementById('next-collection-time');
            
            if (statusData.is_active) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = 'æ´»è·ƒ';
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'æœªè¿è¡Œ';
            }
            
            lastCollectionTime.textContent = statusData.last_collection_time || '-';
            nextCollectionTime.textContent = statusData.next_collection_time || '-';
        }
    
        // ========== ä¸»æœºç›‘æ§åˆ—è¡¨æ¸²æŸ“ ==========
        function renderHostMonitorList() {
            const tbody = document.getElementById('host-monitor-list-body');
            
            if (Object.keys(hostMonitorData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="10">æš‚æ— ä¸»æœºæ•°æ®</td></tr>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            for (const [hostKey, hostData] of Object.entries(hostMonitorData)) {
                const parts = hostKey.split('-');
                if (parts.length < 3) continue;
                
                const row = document.createElement('tr');
                row.setAttribute('data-ip', parts[0]);
                row.setAttribute('data-user', parts[1]);
                row.setAttribute('data-port', parts.slice(2).join('-'));
                
                // è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
                const statusText = hostData.is_online ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const statusClass = hostData.is_online ? 'status-online' : 'status-offline';
                
                // è·å–ç›‘æ§é¡¹æ–‡æœ¬
                const monitorItems = [];
                if (hostData.monitor_cpu) monitorItems.push('CPU');
                if (hostData.monitor_memory) monitorItems.push('å†…å­˜');
                if (hostData.monitor_disk) monitorItems.push('ç£ç›˜');
                if (hostData.monitor_network) monitorItems.push('ç½‘ç»œ');
                
                row.innerHTML = `
                    <td>${hostData.ip || parts[0]}</td>
                    <td>${hostData.user || parts[1]}</td>
                    <td>${hostData.port || parts.slice(2).join('-')}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${monitorItems.join(', ') || '-'}</td>
                    <td class="cpu-cell">
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressClass(hostData.cpu_usage || 0)}" style="width: ${hostData.cpu_usage || 0}%"></div>
                        </div>
                        <span>${(hostData.cpu_usage || 0).toFixed(1)}%</span>
                    </td>
                    <td class="memory-cell">
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressClass(hostData.memory_usage || 0)}" style="width: ${hostData.memory_usage || 0}%"></div>
                        </div>
                        <span>${(hostData.memory_usage || 0).toFixed(1)}%</span>
                    </td>
                    <td class="disk-cell">
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressClass(hostData.disk_usage || 0)}" style="width: ${hostData.disk_usage || 0}%"></div>
                        </div>
                        <span>${(hostData.disk_usage || 0).toFixed(1)}%</span>
                    </td>
                    <td>${hostData.last_check || '-'}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editHostMonitor('${hostKey}')">ç¼–è¾‘</button>
                        <button class="action-btn ${hostData.status === 'paused' ? 'resume-btn' : 'pause-btn'}" onclick="toggleMonitorStatus('${hostKey}')">
                            ${hostData.status === 'paused' ? 'å¯ç”¨' : 'æš‚åœ'}
                        </button>
                    </td>
                `;
                
                fragment.appendChild(row);
            }
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }
    
        // ========== æ•°æ®è·å–å‡½æ•° ==========
        function getRecentLogs(limit = 50) {
            return fetch('/get_recent_logs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return data;
                    } else {
                        return {
                            logs: ['æ­£åœ¨åŠ è½½ç›‘æ§æ—¥å¿—...'],
                            count: 1,
                            type: 'system'
                        };
                    }
                })
                .catch(error => {
                    console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
                    return {
                        logs: ['è·å–æ—¥å¿—å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥'],
                        count: 1,
                        type: 'error'
                    };
                });
        }
    
        // ========== ç»Ÿä¸€æ•°æ®è·å–å‡½æ•° ==========
        function fetchMonitorData() {
            console.log('å¼€å§‹è·å–ç›‘æ§æ•°æ®...');
            
            fetch('/api/monitor_management_data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateAllData(data);
                        hideLoading();
                    } else {
                        updateLogsView({
                            logs: [`æœåŠ¡å™¨é”™è¯¯: ${data.message}`, 'è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ'],
                            count: 2,
                            type: 'error'
                        });
                        hideLoading();
                    }
                })
                .catch(error => {
                    updateLogsView({
                        logs: [
                            'è¿æ¥æœåŠ¡å™¨å¤±è´¥',
                            `é”™è¯¯ä¿¡æ¯: ${error.message}`,
                            'è¯·æ£€æŸ¥:',
                            '1. FlaskæœåŠ¡æ˜¯å¦å¯åŠ¨',
                            '2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸',
                            '3. é˜²ç«å¢™è®¾ç½®'
                        ],
                        count: 6,
                        type: 'error'
                    });
                    hideLoading();
                });
        }
    
        // ========== æ›´æ–°æ‰€æœ‰æ•°æ® ==========
        function updateAllData(data) {
            // æ›´æ–°ä¸»æœºç›‘æ§æ•°æ®
            if (data.hosts && Object.keys(data.hosts).length > 0) {
                hostMonitorData = data.hosts;
                renderHostMonitorList();
            } else {
                const tbody = document.getElementById('host-monitor-list-body');
                tbody.innerHTML = '<tr><td colspan="10">æš‚æ— ä¸»æœºç›‘æ§æ•°æ®</td></tr>';
            }
            
            // æ›´æ–°é‡‡é›†çŠ¶æ€
            if (data.collection_status) {
                updateCollectionStatusFromData(data.collection_status);
            }
            
            // æ›´æ–°æ—¥å¿—
            if (data.recent_logs && data.recent_logs.logs) {
                updateLogsView(data.recent_logs);
            }
        }
    
        // ========== è¾…åŠ©å‡½æ•° ==========
        function getProgressClass(value) {
            if (value < 70) return 'progress-low';
            if (value < 90) return 'progress-medium';
            return 'progress-high';
        }
    
        function hideLoading() {
            const loading = document.getElementById('global-loading');
            if (loading) {
                loading.remove();
            }
        }
    
        // ========== æ“ä½œåŠŸèƒ½ ==========
        function toggleMonitorStatus(hostKey) {
            if (!hostMonitorData[hostKey]) return;
            
            const currentStatus = hostMonitorData[hostKey].status || 'active';
            const newStatus = currentStatus === 'active' ? 'paused' : 'active';
            
            hostMonitorData[hostKey].status = newStatus;
            renderHostMonitorList();
        }
    
        function editHostMonitor(hostKey) {
            if (!hostMonitorData[hostKey]) return;
            
            const hostData = hostMonitorData[hostKey];
            const parts = hostKey.split('-');
            const ip = parts[0];
            const user = parts[1];
            const port = parts.slice(2).join('-');
            
            document.getElementById('modal-title').textContent = 'ç¼–è¾‘ä¸»æœºç›‘æ§';
            document.getElementById('modal-host-info').textContent = `${ip}:${port} (ç”¨æˆ·: ${user})`;
            document.getElementById('modal-host-id').value = hostKey;
            
            document.getElementById('modal-monitor-cpu').checked = hostData.monitor_cpu || false;
            document.getElementById('modal-monitor-memory').checked = hostData.monitor_memory || false;
            document.getElementById('modal-monitor-disk').checked = hostData.monitor_disk || false;
            document.getElementById('modal-monitor-network').checked = hostData.monitor_network || false;
            document.getElementById('modal-status').value = hostData.status || 'active';
            
            document.getElementById('host-monitor-modal').style.display = 'block';
        }
    
        function closeHostMonitorModal() {
            document.getElementById('host-monitor-modal').style.display = 'none';
        }
    
        // ========== æ¨¡æ€çª—å£ç®¡ç† ==========
        function openGlobalConfigModal() {
            // åŠ è½½å½“å‰é…ç½®
            fetch('/get_current_config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('modal-global-interval').value = data.interval || 300;
                        document.getElementById('modal-global-cleanup-days').value = data.cleanup_days || 30;
                        document.getElementById('modal-global-cpu').checked = data.monitor_cpu !== false;
                        document.getElementById('modal-global-memory').checked = data.monitor_memory !== false;
                        document.getElementById('modal-global-disk').checked = data.monitor_disk !== false;
                        document.getElementById('modal-global-network').checked = data.monitor_network !== false;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                });
            
            document.getElementById('global-config-modal').style.display = 'block';
        }

    
        function closeGlobalConfigModal() {
            document.getElementById('global-config-modal').style.display = 'none';
        }
    
        // ========== äº‹ä»¶ç›‘å¬å™¨è®¾ç½® ==========
        document.addEventListener('DOMContentLoaded', function() {
            // å®‰å…¨æ·»åŠ æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
            safeAddEventListener('host-monitor-form', 'submit', function(e) {
                e.preventDefault();
                const hostId = document.getElementById('modal-host-id').value;
                if (hostMonitorData[hostId]) {
                    hostMonitorData[hostId].monitor_cpu = document.getElementById('modal-monitor-cpu').checked;
                    hostMonitorData[hostId].monitor_memory = document.getElementById('modal-monitor-memory').checked;
                    hostMonitorData[hostId].monitor_disk = document.getElementById('modal-monitor-disk').checked;
                    hostMonitorData[hostId].monitor_network = document.getElementById('modal-monitor-network').checked;
                    hostMonitorData[hostId].status = document.getElementById('modal-status').value;
                    renderHostMonitorList();
                    closeHostMonitorModal();
                }
            });
    
            safeAddEventListener('edit-global-config', 'click', openGlobalConfigModal);
            safeAddEventListener('global-config-form', 'submit', function(e) {
                e.preventDefault();
                
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'ä¿å­˜ä¸­...';
                
                const configData = {
                    interval: parseInt(document.getElementById('modal-global-interval').value),
                    cleanup_days: parseInt(document.getElementById('modal-global-cleanup-days').value),
                    auto_cleanup: true, // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ¸…ç†
                    monitor_cpu: document.getElementById('modal-global-cpu').checked,
                    monitor_memory: document.getElementById('modal-global-memory').checked,
                    monitor_disk: document.getElementById('modal-global-disk').checked,
                    monitor_network: document.getElementById('modal-global-network').checked
                };
                
                fetch('/save_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(configData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        submitBtn.innerHTML = 'ä¿å­˜æˆåŠŸ';
                        setTimeout(() => {
                            closeGlobalConfigModal();
                            submitBtn.innerHTML = 'ä¿å­˜é…ç½®';
                            submitBtn.disabled = false;
                            // åˆ·æ–°é¡µé¢çŠ¶æ€
                            fetchMonitorData();
                        }, 1000);
                    } else {
                        submitBtn.innerHTML = 'ä¿å­˜å¤±è´¥';
                        setTimeout(() => {
                            submitBtn.innerHTML = 'ä¿å­˜é…ç½®';
                            submitBtn.disabled = false;
                        }, 2000);
                        alert('ä¿å­˜é…ç½®å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    submitBtn.innerHTML = 'è¯·æ±‚å¤±è´¥';
                    setTimeout(() => {
                        submitBtn.innerHTML = 'ä¿å­˜é…ç½®';
                        submitBtn.disabled = false;
                    }, 2000);
                    alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
                });
            });
            

            safeAddEventListener('run-now', 'click', function() {
                this.disabled = true;
                this.innerHTML = 'æ‰§è¡Œä¸­...';
                fetch('/trigger_collection', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.innerHTML = 'æ‰§è¡ŒæˆåŠŸ';
                            setTimeout(() => {
                                fetchMonitorData();
                                this.innerHTML = 'ç«‹å³æ‰§è¡Œé‡‡é›†';
                                this.disabled = false;
                            }, 3000);
                        } else {
                            this.innerHTML = 'æ‰§è¡Œå¤±è´¥';
                            setTimeout(() => {
                                this.innerHTML = 'ç«‹å³æ‰§è¡Œé‡‡é›†';
                                this.disabled = false;
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('è§¦å‘é‡‡é›†å¤±è´¥:', error);
                        this.innerHTML = 'è¯·æ±‚å¤±è´¥';
                        setTimeout(() => {
                            this.innerHTML = 'ç«‹å³æ‰§è¡Œé‡‡é›†';
                            this.disabled = false;
                        }, 3000);
                    });
            });
    
            safeAddEventListener('refresh-status', 'click', function() {
                this.disabled = true;
                this.innerHTML = 'åˆ·æ–°ä¸­...';
                fetchMonitorData();
                setTimeout(() => {
                    this.innerHTML = 'åˆ·æ–°çŠ¶æ€';
                    this.disabled = false;
                }, 1000);
            });
    
            safeAddEventListener('refresh-logs', 'click', function() {
                this.disabled = true;
                this.innerHTML = 'åˆ·æ–°ä¸­...';
                fetchMonitorData();
                setTimeout(() => {
                    this.innerHTML = 'åˆ·æ–°æ—¥å¿—';
                    this.disabled = false;
                }, 1000);
            });
    
            safeAddEventListener('clear-logs', 'click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    fetch('/clear_logs', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('æ—¥å¿—å·²æ¸…ç©º');
                                fetchMonitorData();
                            } else {
                                alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', error);
                            alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥');
                        });
                }
            });
    
            safeAddEventListener('refresh-hosts', 'click', function() {
                this.disabled = true;
                this.innerHTML = 'åˆ·æ–°ä¸­...';
                fetchMonitorData();
                setTimeout(() => {
                    this.innerHTML = 'åˆ·æ–°ä¸»æœºåˆ—è¡¨';
                    this.disabled = false;
                }, 1000);
            });
    
            // åˆå§‹åŒ–æ•°æ®åŠ è½½
            fetchMonitorData();
            setInterval(fetchMonitorData, 30000);
        });
    
        // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('host-monitor-modal');
            if (event.target == modal) {
                closeHostMonitorModal();
            }
            const globalModal = document.getElementById('global-config-modal');
            if (event.target == globalModal) {
                closeGlobalConfigModal();
            }
        }

        // ========== ç½‘ç»œæµé‡å›¾è¡¨åŠŸèƒ½ ==========
        let networkChart = null;

        function initializeNetworkChart() {
            const ctx = document.getElementById('networkChart').getContext('2d');
            
            if (networkChart) {
                networkChart.destroy();
            }
            
            networkChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'æ¥æ”¶æµé‡ (MB)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'å‘é€æµé‡ (MB)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ç½‘ç»œæµé‡è¶‹åŠ¿'
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æµé‡ (MB)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // åŠ è½½åˆå§‹æ•°æ®
            loadNetworkTrends();
        }

        function loadNetworkTrends() {
            fetch('/api/network_trends?limit=20')
                .then(response => response.json())
                .then(data => {
                    if (data.success && networkChart) {
                        updateNetworkChart(data);
                    } else {
                        console.error('è·å–ç½‘ç»œæµé‡æ•°æ®å¤±è´¥:', data.message);
                        showNetworkChartError('è·å–ç½‘ç»œæµé‡æ•°æ®å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
                    showNetworkChartError('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                });
        }

        function updateNetworkChart(trendData) {
            if (!networkChart || !trendData.success) return;
            
            // æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
            if (!trendData.data || !trendData.data.labels || !trendData.data.datasets) {
                console.error('æ•°æ®æ ¼å¼é”™è¯¯:', trendData);
                showNetworkChartError('æ•°æ®æ ¼å¼é”™è¯¯');
                return;
            }
            
            // æ›´æ–°æ—¶é—´æˆ³æ ‡ç­¾ - ä½¿ç”¨åç«¯è¿”å›çš„å·²æ ¼å¼åŒ–æ ‡ç­¾
            networkChart.data.labels = trendData.data.labels;
            
            // æ›´æ–°æ¥æ”¶æµé‡æ•°æ®
            if (trendData.data.datasets[0] && trendData.data.datasets[0].data) {
                networkChart.data.datasets[0].data = trendData.data.datasets[0].data;
            }
            
            // æ›´æ–°å‘é€æµé‡æ•°æ®
            if (trendData.data.datasets[1] && trendData.data.datasets[1].data) {
                networkChart.data.datasets[1].data = trendData.data.datasets[1].data;
            }
            
            // æ›´æ–°å›¾è¡¨
            networkChart.update();
        }

        function showNetworkChartError(message) {
            const canvas = document.getElementById('networkChart');
            const ctx = canvas.getContext('2d');
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(message, canvas.width / 2, canvas.height / 2);
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥Canvaså…ƒç´ æ˜¯å¦å­˜åœ¨
            const canvas = document.getElementById('networkChart');
            if (!canvas) {
                console.error('Canvaså…ƒç´ æœªæ‰¾åˆ°ï¼Œç½‘ç»œæµé‡å›¾è¡¨æ— æ³•åˆå§‹åŒ–');
                return;
            }
            
            // åˆå§‹åŒ–ç½‘ç»œæµé‡å›¾è¡¨
            initializeNetworkChart();
            
            // å®šæœŸåˆ·æ–°ç½‘ç»œæµé‡æ•°æ®
            setInterval(loadNetworkTrends, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
            
            // åœ¨ç»Ÿä¸€æ•°æ®æ›´æ–°å‡½æ•°ä¸­ä¹Ÿåˆ·æ–°ç½‘ç»œå›¾è¡¨
            const originalUpdateAllData = updateAllData;
            updateAllData = function(data) {
                originalUpdateAllData(data);
                loadNetworkTrends(); // åˆ·æ–°ç½‘ç»œæµé‡å›¾è¡¨
            };
        });



    </script>
    
    <!-- ç½‘ç»œæµé‡å›¾è¡¨ -->
    <div class="monitor-config-card">
        <h3>ç½‘ç»œæµé‡è¶‹åŠ¿ (æœ€è¿‘10æ¬¡)</h3>
        <canvas id="networkChart" height="200"></canvas>
    </div>

</body>
</html>
